name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── Fast check: always runs on every push ─────────────────────────────────
  check:
    name: Check & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo check --workspace
      - run: cargo clippy --workspace -- -D warnings

  # ── Test: always runs on every push ───────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --workspace

  # ── Auto-tag: only runs when Cargo.toml version changes on main ──────────
  auto-tag:
    name: Auto Tag on Version Bump
    runs-on: ubuntu-latest
    # Only run on direct push to main (not PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    outputs:
      version_changed: ${{ steps.check_version.outputs.changed }}
      new_version: ${{ steps.check_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need parent commit to diff against

      - name: Check if version changed in Cargo.toml
        id: check_version
        shell: bash
        run: |
          # Read current version from workspace Cargo.toml
          CURRENT=$(grep '^version' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT"

          # Read version from parent commit
          PREV=$(git show HEAD~1:Cargo.toml 2>/dev/null | grep '^version' | head -1 | sed 's/version = "\(.*\)"/\1/' || echo "")
          echo "Previous version: $PREV"

          if [ "$CURRENT" != "$PREV" ] && [ -n "$CURRENT" ]; then
            echo "Version changed: $PREV → $CURRENT"
            echo "changed=true"  >> "$GITHUB_OUTPUT"
            echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
          else
            echo "Version unchanged — skipping release."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
          fi

      - name: Create and push annotated tag
        if: steps.check_version.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          VERSION="v${{ steps.check_version.outputs.version }}"
          echo "Creating tag $VERSION ..."

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete remote tag if it already exists (safe force-push equivalent)
          git push origin :refs/tags/$VERSION 2>/dev/null || true

          git tag -a "$VERSION" -m "Release $VERSION (auto-tagged by CI on version bump)"
          git push origin "$VERSION"
          echo "✅ Tag $VERSION pushed — release workflow will now start."
